<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LyricArt Studio - Where Lyrics Become Art</title>
    <link rel="stylesheet" href="../css/main.css" />
    <meta name="description" content="Transform your favorite song lyrics into stunning visual art. Premium digital marketplace for music-inspired typographic designs." />
    <!-- OpenSeadragon for high-resolution zoomable images -->
    <script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <!-- Fallback CDN if main one fails -->
    <script>
        if (typeof OpenSeadragon === 'undefined') {
            console.log('🔄 Loading OpenSeadragon from fallback CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/openseadragon@3.1.0/build/openseadragon/openseadragon.min.js';
            document.head.appendChild(script);
        }
    </script>
    <!-- Enhanced protected image viewer -->
    <!-- OpenSeadragon viewer script removed to fix cart functionality -->
    <!-- Rocket.js script removed to fix cart functionality -->
</head>
<body class="bg-background text-text-primary font-inter">
    <!-- Navigation Header -->
    <header class="fixed top-0 w-full z-50 bg-background/90 backdrop-blur-md border-b border-border-subtle">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"/>
                        <path d="M19 15L19.5 17L21 17.5L19.5 18L19 20L18.5 18L17 17.5L18.5 17L19 15Z"/>
                        <path d="M5 15L5.5 17L7 17.5L5.5 18L5 20L4.5 18L3 17.5L4.5 17L5 15Z"/>
                    </svg>
                    <span class="text-xl font-montserrat font-bold">LyricArt Studio</span>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/homepage" class="text-accent font-medium">Home</a>
                    <a href="/browse" class="text-text-secondary hover:text-accent transition-smooth">Browse Gallery</a>
                    <a href="/artist-profiles" class="text-text-secondary hover:text-accent transition-smooth">Artists</a>
                    <a href="/my-collection" class="text-text-secondary hover:text-accent transition-smooth">My Collection</a>
                </div>

                <!-- Search & User Actions -->
                <div class="flex items-center space-x-4">
                    <button class="hidden md:block p-2 text-text-secondary hover:text-accent transition-smooth">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                    
                    <!-- Shopping Cart -->
                    <button id="cart-button" onclick="window.location.href='/pages/checkout.html'" class="relative p-2 text-text-secondary hover:text-accent transition-smooth">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-sm font-bold rounded-full h-6 w-6 flex items-center justify-center shadow-lg border-2 border-white">0</span>
                    </button>
                    
                    <!-- User Authentication -->
                    <div id="auth-buttons" class="flex items-center space-x-2">
                        <a href="/login" class="text-text-secondary hover:text-accent transition-smooth text-sm font-medium">Login</a>
                        <a href="/register" class="bg-accent text-background px-4 py-2 rounded-lg hover:bg-accent/90 transition-smooth text-sm font-medium">Register</a>
                    </div>
                    
                    <!-- User Menu (hidden when not logged in) -->
                    <div id="user-menu" class="hidden flex items-center space-x-2">
                        <span id="user-email" class="text-text-secondary text-sm"></span>
                        <button onclick="logout()" class="text-text-secondary hover:text-accent transition-smooth text-sm font-medium">Logout</button>
                    </div>
                    
                    <!-- Auth Status Indicator (for debugging) -->
                    <div id="auth-status-indicator" class="hidden text-red-500 text-xs bg-red-100 px-2 py-1 rounded">
                        Checking auth...
                    </div>
                    
                    <!-- Mobile Menu Button -->
                    <button class="md:hidden p-2 text-text-secondary hover:text-accent transition-smooth">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Enhanced Particle Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <!-- Large floating particles -->
        <div class="absolute top-20 left-10 w-3 h-3 bg-accent rounded-full opacity-80 animate-particle-slow shadow-lg shadow-accent/50"></div>
        <div class="absolute top-40 right-20 w-2 h-2 bg-accent rounded-full opacity-70 animate-particle-medium shadow-lg shadow-accent/40"></div>
        <div class="absolute top-60 left-1/4 w-2.5 h-2.5 bg-accent rounded-full opacity-90 animate-particle-fast shadow-lg shadow-accent/60"></div>
        <div class="absolute bottom-40 right-1/3 w-3 h-3 bg-accent rounded-full opacity-75 animate-particle-slow shadow-lg shadow-accent/50"></div>
        <div class="absolute bottom-60 left-1/2 w-2 h-2 bg-accent rounded-full opacity-85 animate-particle-medium shadow-lg shadow-accent/45"></div>
        <div class="absolute top-1/3 right-10 w-2.5 h-2.5 bg-accent rounded-full opacity-80 animate-particle-fast shadow-lg shadow-accent/55"></div>
        
        <!-- Medium particles -->
        <div class="absolute top-32 left-1/3 w-1.5 h-1.5 bg-accent rounded-full opacity-60 animate-particle-medium shadow-md shadow-accent/30"></div>
        <div class="absolute top-80 right-1/4 w-1.5 h-1.5 bg-accent rounded-full opacity-65 animate-particle-slow shadow-md shadow-accent/35"></div>
        <div class="absolute bottom-80 left-1/5 w-1.5 h-1.5 bg-accent rounded-full opacity-70 animate-particle-fast shadow-md shadow-accent/40"></div>
        <div class="absolute top-1/2 right-1/6 w-1.5 h-1.5 bg-accent rounded-full opacity-55 animate-particle-medium shadow-md shadow-accent/25"></div>
        
        <!-- Small particles -->
        <div class="absolute top-16 left-1/2 w-1 h-1 bg-accent rounded-full opacity-50 animate-particle-fast"></div>
        <div class="absolute top-48 right-1/2 w-1 h-1 bg-accent rounded-full opacity-45 animate-particle-slow"></div>
        <div class="absolute bottom-32 left-1/3 w-1 h-1 bg-accent rounded-full opacity-60 animate-particle-medium"></div>
        <div class="absolute bottom-80 right-1/5 w-1 h-1 bg-accent rounded-full opacity-55 animate-particle-fast"></div>
        <div class="absolute top-3/4 left-1/6 w-1 h-1 bg-accent rounded-full opacity-50 animate-particle-slow"></div>
        <div class="absolute top-1/4 right-1/3 w-1 h-1 bg-accent rounded-full opacity-65 animate-particle-medium"></div>
        
        <!-- Additional particles for more density -->
        <div class="absolute top-96 left-1/4 w-1.5 h-1.5 bg-accent rounded-full opacity-70 animate-particle-slow shadow-md shadow-accent/30"></div>
        <div class="absolute top-64 right-1/3 w-1 h-1 bg-accent rounded-full opacity-50 animate-particle-fast"></div>
        <div class="absolute bottom-96 left-2/3 w-2 h-2 bg-accent rounded-full opacity-80 animate-particle-medium shadow-lg shadow-accent/40"></div>
        <div class="absolute top-1/3 left-1/6 w-1 h-1 bg-accent rounded-full opacity-55 animate-particle-slow"></div>
        <div class="absolute bottom-1/3 right-1/4 w-1.5 h-1.5 bg-accent rounded-full opacity-75 animate-particle-fast shadow-md shadow-accent/35"></div>
        
        <!-- Glowing orbs for extra effect -->
        <div class="absolute top-1/4 left-1/5 w-4 h-4 bg-accent rounded-full opacity-30 animate-pulse blur-sm"></div>
        <div class="absolute bottom-1/4 right-1/5 w-3 h-3 bg-accent rounded-full opacity-25 animate-pulse blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 w-2 h-2 bg-accent rounded-full opacity-20 animate-pulse blur-sm"></div>
    </div>

    <!-- Hero Section -->
    <section class="relative min-h-screen flex items-center justify-center pt-20">
        <div class="container mx-auto px-6 text-center">
            <div class="max-w-4xl mx-auto">
                <!-- Main Headline -->
                <h1 class="text-5xl md:text-7xl font-montserrat font-bold mb-6 leading-tight">
                    Where <span class="text-accent">Lyrics</span> Become <span class="text-accent">Art</span>
                </h1>
                
                <!-- Rotating Song Titles -->
                <div class="mb-8 h-16 flex items-center justify-center">
                    <p class="text-xl md:text-2xl text-text-secondary">
                        Transform "<span class="text-accent font-medium" id="rotating-song">Hotel California</span>" into stunning visual art
                    </p>
                </div>

                <!-- CTA Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center mb-12">
                    <a href="/browse" class="btn-primary text-lg px-8 py-4">
                        Explore Gallery
                    </a>
                    <button onclick="openVideoModal()" class="bg-transparent border-2 border-accent text-accent font-montserrat font-semibold px-8 py-4 rounded-lg hover:bg-accent hover:text-primary transition-smooth">
                        Watch Demo
                    </button>
                </div>

                <!-- Social Proof Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-2xl mx-auto">
                    <div class="text-center">
                        <div class="text-2xl font-montserrat font-bold text-accent" id="total-designs">430+</div>
                        <div class="text-sm text-text-secondary">Songs Visualized</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-montserrat font-bold text-accent" id="total-artists">100+</div>
                        <div class="text-sm text-text-secondary">Artists</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-montserrat font-bold text-accent">$3.00</div>
                        <div class="text-sm text-text-secondary">Per Design</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-montserrat font-bold text-accent">4.9★</div>
                        <div class="text-sm text-text-secondary">Rating</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Music Discovery Engine -->
    <section class="py-16 bg-secondary/50">
        <div class="container mx-auto px-6">
            <div class="max-w-2xl mx-auto text-center">
                <h2 class="text-3xl font-montserrat font-bold mb-6">Find Your Song's Visual Soul</h2>
                <div class="relative">
                    <input type="text" id="homepage-search" placeholder="Search by song, artist, or lyric snippet..." class="w-full bg-surface border border-border-subtle rounded-lg px-6 py-4 pr-12 text-text-primary placeholder-text-secondary focus:border-accent focus:outline-none transition-smooth" />
                    <button onclick="searchFromHomepage()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-accent">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </div>
                <p class="text-text-secondary mt-4">Try: "Hotel California", "The Beatles", or "We are the champions"</p>
            </div>
        </div>
    </section>

    <!-- Featured Designs Preview -->
    <section class="py-20">
        <div class="container mx-auto px-6">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-montserrat font-bold mb-4">Featured Designs</h2>
                <p class="text-text-secondary text-lg">Discover our most popular lyric art designs</p>
            </div>

            <div id="featured-designs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Featured designs will be loaded here -->
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
                    <p class="text-text-secondary">Loading featured designs...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Genre Navigation Portals -->
    <section class="py-20">
        <div class="container mx-auto px-6">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-montserrat font-bold mb-4">Explore by Genre</h2>
                <p class="text-text-secondary text-lg">Discover lyric art across all musical styles</p>
            </div>

            <div id="genre-portals" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <!-- Genre portals will be loaded here -->
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
                    <p class="text-text-secondary">Loading genres...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Custom Design Request CTA Section -->
    <section class="py-20">
        <div class="container mx-auto px-6">
            <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl font-montserrat font-bold mb-6">Ready for a Custom Design Request?</h2>
                <p class="text-xl text-text-secondary mb-8">
                    Work directly with our artists to create personalized lyric art that captures your musical memories
                </p>
                <div class="grid md:grid-cols-3 gap-6 mb-12">
                    <div class="card-surface p-6 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-accent/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <h3 class="font-montserrat font-semibold mb-2">Consultation</h3>
                        <p class="text-text-secondary text-sm">Discuss your vision with the artist</p>
                    </div>
                    <div class="card-surface p-6 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-accent/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </div>
                        <h3 class="font-montserrat font-semibold mb-2">Creation</h3>
                        <p class="text-text-secondary text-sm">Watch your design come to life</p>
                    </div>
                    <div class="card-surface p-6 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-accent/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </div>
                        <h3 class="font-montserrat font-semibold mb-2">Delivery</h3>
                        <p class="text-text-secondary text-sm">Receive your unique masterpiece</p>
                    </div>
                </div>
                <button onclick="openCommissionModal()" class="btn-primary text-lg px-8 py-4">CUSTOM DESIGN REQUEST</button>
                
                <!-- Newsletter Subscription -->
                <div class="mt-8 max-w-md mx-auto">
                    <div class="bg-surface/50 backdrop-blur-md rounded-lg p-6 border border-border-subtle">
                        <h3 class="text-lg font-semibold text-text-primary mb-3">Stay Updated</h3>
                        <p class="text-text-secondary text-sm mb-4">Get notified about new designs and exclusive offers!</p>
                        <div class="flex space-x-2">
                            <input type="email" id="subscription-email" placeholder="Enter your email" 
                                   class="flex-1 px-4 py-2 bg-background border border-border-subtle rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary placeholder-text-secondary text-sm">
                            <button onclick="subscribe()" class="bg-accent text-background px-4 py-2 rounded-lg hover:bg-accent/90 transition-smooth text-sm font-medium">
                                Subscribe
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50"></div>

    <!-- Footer -->
    <footer class="bg-secondary border-t border-border-subtle py-12">
        <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-4 gap-8">
                <!-- Brand -->
                <div>
                    <div class="flex items-center space-x-3 mb-4">
                        <svg class="w-8 h-8 text-accent" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"/>
                            <path d="M19 15L19.5 17L21 17.5L19.5 18L19 20L18.5 18L17 17.5L18.5 17L19 15Z"/>
                            <path d="M5 15L5.5 17L7 17.5L5.5 18L5 20L4.5 18L3 17.5L4.5 17L5 15Z"/>
                        </svg>
                        <span class="text-xl font-montserrat font-bold">LyricArt Studio</span>
                    </div>
                    <p class="text-text-secondary text-sm">Transforming your favorite lyrics into stunning visual art since 2020.</p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="font-montserrat font-semibold mb-4">Explore</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="/browse" class="text-text-secondary hover:text-accent transition-smooth">Browse Gallery</a></li>
                        <li><a href="/artist-profiles" class="text-text-secondary hover:text-accent transition-smooth">Artists</a></li>
                        <li><a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">Genres</a></li>
                        <li><a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">New Releases</a></li>
                    </ul>
                </div>

                <!-- Support -->
                <div>
                    <h4 class="font-montserrat font-semibold mb-4">Support</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">Help Center</a></li>
                        <li><a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">Download Guide</a></li>
                        <li><a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">Licensing</a></li>
                        <li><a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">Contact Us</a></li>
                    </ul>
                </div>

                <!-- Connect -->
                <div>
                    <h4 class="font-montserrat font-semibold mb-4">Connect</h4>
                    <div class="flex space-x-4">
                        <a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.36 2.165-2.38-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/>
                            </svg>
                        </a>
                        <a href="javascript:void(0)" class="text-text-secondary hover:text-accent transition-smooth">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>

            <div class="border-t border-border-subtle mt-8 pt-8 text-center">
                <p class="text-text-secondary text-sm">© 2025 LyricArt Studio. All Rights Reserved.</p>
                <p class="text-text-secondary text-xs mt-2">
                    Copyright Disclaimer: All song titles, lyrics, and artist names are trademarks and copyrights of their respective owners. 
                    These designs are sold as artistic interpretations for personal, non-commercial use only. 
                    No commercial rights to the underlying musical works are conveyed with purchase.
                </p>
            </div>
        </div>
    </footer>

    <!-- Homepage JavaScript -->
    <script>
        // Rotating song titles
        const songTitles = [
            "Hotel California", "Bohemian Rhapsody", "Stairway to Heaven", 
            "Imagine", "Sweet Child O' Mine", "Wonderwall", "Creep",
            "Smells Like Teen Spirit", "Nothing Else Matters", "Sweet Home Alabama"
        ];
        
        let currentSongIndex = 0;
        const rotatingSongElement = document.getElementById('rotating-song');
        
        function rotateSongTitles() {
            currentSongIndex = (currentSongIndex + 1) % songTitles.length;
            if (rotatingSongElement) {
                rotatingSongElement.textContent = songTitles[currentSongIndex];
            }
        }
        
        setInterval(rotateSongTitles, 3000);

        // Search functionality
        function searchFromHomepage() {
            const searchInput = document.getElementById('homepage-search');
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm) {
                // Redirect to browse gallery with search term
                window.location.href = `/browse?search=${encodeURIComponent(searchTerm)}`;
            }
        }

        // Enter key search
        document.getElementById('homepage-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFromHomepage();
            }
        });

        // Load real data when catalog is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Image viewer status check
            console.log('Image viewer ready for use');
            
            // Initialize cart badge
            updateCartBadge();
            
            // Wait for song catalog to initialize
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (window.songCatalog && window.songCatalog.songs.length > 0) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });

            const catalog = window.songCatalog;
            
            // Update metrics
            document.getElementById('total-designs').textContent = catalog.songs.length + '+';
            document.getElementById('total-artists').textContent = catalog.artists.size + '+';
            
            // Load featured designs
            loadFeaturedDesigns(catalog);
            
            // Load genre portals
            loadGenrePortals(catalog);
        });

        function loadFeaturedDesigns(catalog) {
            const featuredContainer = document.getElementById('featured-designs');
            
            // Get 8 featured designs (mix of popular and new)
            const featuredDesigns = catalog.songs
                .sort((a, b) => b.popularity - a.popularity)
                .slice(0, 8);
            
            featuredContainer.innerHTML = featuredDesigns.map(design => `
                <div class="group cursor-pointer" onclick="openDesignModal('/${design.webp}', '${design.song}', '${design.artist}', '${design.instrumentShape}', ${design.price}, '/${design.webp}')">
                    <div class="card-surface overflow-hidden hover:border-accent transition-smooth group-hover:shadow-accent-glow">
                        <div class="relative aspect-square" style="background-color: white;">
                            <picture>
                                <source srcset="/${design.webp}" type="image/webp">
                                <img src="/${design.image}" alt="${design.song} by ${design.artist}" 
                                     class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-300" style="padding: 8px;">
                            </picture>
                            <div class="absolute top-2 right-2 bg-accent text-primary text-xs px-2 py-1 rounded">
                                $${design.price.toFixed(2)}
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-montserrat font-semibold text-lg mb-1 truncate">${design.song}</h3>
                            <p class="text-text-secondary text-sm">${design.artist}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadGenrePortals(catalog) {
            const genreContainer = document.getElementById('genre-portals');
            
            // Get top genres with counts
            const genres = Array.from(catalog.genres.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const genreIcons = {
                'Rock': '<path d="M12 2L15.09 8.26L22 9L15.09 9.74L12 16L8.91 9.74L2 9L8.91 8.26L12 2Z"/>',
                'Country': '<path d="M6 2L3 6V20C3 21.1 3.9 22 5 22H19C20.1 22 21 21.1 21 20V6L18 2H6ZM12 4L14 6H10L12 4ZM5 8H19V20H5V8Z"/>',
                'Pop': '<path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20Z"/><circle cx="12" cy="12" r="3"/>',
                'Alternative Rock': '<path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"/>',
                'Classic Rock': '<path d="M12 2L15.09 8.26L22 9L15.09 9.74L12 16L8.91 9.74L2 9L8.91 8.26L12 2Z"/>'
            };
            
            genreContainer.innerHTML = genres.map(([genre, count]) => `
                <div class="group cursor-pointer" onclick="window.location.href='/browse?genre=${encodeURIComponent(genre)}'">
                    <div class="card-surface p-6 text-center hover:border-accent transition-smooth group-hover:shadow-accent-glow">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-accent to-accent/50 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                                ${genreIcons[genre] || '<path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"/>'}
                            </svg>
                        </div>
                        <h3 class="font-montserrat font-semibold mb-2">${genre}</h3>
                        <p class="text-text-secondary text-sm">${count}+ designs</p>
                    </div>
                </div>
            `).join('');
        }

        // Global function for opening design modal (same as in song-catalog.js)
        function openDesignModal(imageSrc, songTitle, artistName, shape, price, highResPath) {
            // Use the correct image path directly - no need to convert from images/designs to music_lyricss
            let correctedImageSrc = imageSrc;
            let correctedHighResPath = highResPath || imageSrc;
            if (!correctedImageSrc.startsWith('/')) {
                correctedImageSrc = '/' + correctedImageSrc;
                correctedHighResPath = '/' + correctedHighResPath;
            }
            
            const modalHTML = `
                <div id="design-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.8);">
                    <div class="relative w-full max-w-4xl max-h-[95vh] overflow-y-auto rounded-lg" style="background-color: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                        <!-- Close button - positioned absolutely for mobile -->
                        <button onclick="closeDesignModal()" class="absolute top-4 right-4 z-10 p-2 rounded-full" style="background-color: rgba(255, 255, 255, 0.9); color: #6B7280; backdrop-filter: blur(4px);">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <div class="p-4 sm:p-6">
                            <!-- Header -->
                            <div class="mb-4 pr-12">
                                <h2 class="text-xl sm:text-2xl font-bold" style="color: #111827;">${songTitle}</h2>
                                <p style="color: #6B7280;">by ${artistName}</p>
                            </div>
                            
                            <!-- Content Grid - Stack on mobile, side-by-side on desktop -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                                            <!-- Image Section -->
                            <div class="space-y-4">
                                <div class="aspect-square rounded-lg overflow-hidden relative" style="background-color: white; border: 1px solid #E5E7EB; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                                    <picture>
                                        <source srcset="${correctedImageSrc}" type="image/webp">
                                        <img src="${correctedImageSrc.replace('.webp', '.png')}" alt="${songTitle}" 
                                             class="w-full h-full object-contain" style="padding: 16px;">
                                    </picture>
                                    
                                    <!-- OpenSeadragon Zoom Button -->
                                    <button onclick="openProtectedDesignViewer('${correctedHighResPath}', '${songTitle}', '${artistName}')" 
                                            class="absolute top-2 right-2 bg-accent text-white p-2 rounded-full opacity-0 hover:opacity-100 transition-opacity duration-300 cursor-pointer"
                                            title="Zoom to see high-resolution details">
                                        <span class="text-sm">🔍</span>
                                    </button>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span style="background-color: #DBEAFE; color: #1E40AF; font-size: 12px; padding: 4px 8px; border-radius: 4px;">${shape}</span>
                                        <span style="background-color: #D1FAE5; color: #065F46; font-size: 12px; padding: 4px 8px; border-radius: 4px;">High Quality</span>
                                    </div>
                                </div>
                                
                                <!-- Details Section -->
                                <div class="space-y-4">
                                    <div class="text-2xl sm:text-3xl font-bold" style="color: #2563EB;">$${price.toFixed(2)}</div>
                                    <p style="color: #6B7280; font-size: 14px; line-height: 1.5;">
                                        This high-quality digital design is perfect for printing, vinyl cutting, 
                                        embroidery, laser engraving, or any other creative project. Each design 
                                        comes in multiple formats to ensure compatibility with your preferred software.
                                    </p>
                                    
                                    <div class="space-y-2">
                                        <h4 class="font-semibold text-sm sm:text-base" style="color: #111827;">Available Formats:</h4>
                                        <div class="flex flex-wrap gap-2">
                                            <span style="background-color: #F3F4F6; color: #374151; font-size: 12px; padding: 4px 8px; border-radius: 4px;">SVG</span>
                                            <span style="background-color: #F3F4F6; color: #374151; font-size: 12px; padding: 4px 8px; border-radius: 4px;">PDF</span>
                                            <span style="background-color: #F3F4F6; color: #374151; font-size: 12px; padding: 4px 8px; border-radius: 4px;">PNG</span>
                                            <span style="background-color: #F3F4F6; color: #374151; font-size: 12px; padding: 4px 8px; border-radius: 4px;">EPS</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="space-y-3 pt-2">
                                        <button onclick="addToCart('${songTitle}', ${price})" style="width: 100%; background-color: #2563EB; color: white; padding: 12px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#1D4ED8'" onmouseout="this.style.backgroundColor='#2563EB'">
                                            Add to Cart
                                        </button>
                                        <button onclick="buyNow('${songTitle}', ${price})" style="width: 100%; background-color: #059669; color: white; padding: 12px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#047857'" onmouseout="this.style.backgroundColor='#059669'">
                                            Buy Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Add click outside to close functionality
            const modal = document.getElementById('design-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDesignModal();
                }
            });
            
            // Add escape key to close functionality
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDesignModal();
                }
            });
        }

        function closeDesignModal() {
            const modal = document.getElementById('design-modal');
            if (modal) {
                modal.remove();
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }

        // Video Modal Functions
        function openVideoModal() {
            const modalHTML = `
                <div id="video-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.9);">
                    <div class="relative w-full max-w-4xl max-h-[90vh] rounded-lg overflow-hidden" style="background-color: #000;">
                        <!-- Close button -->
                        <button onclick="closeVideoModal()" class="absolute top-4 right-4 z-10 p-2 rounded-full" style="background-color: rgba(255, 255, 255, 0.2); color: white; backdrop-filter: blur(4px);">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        
                        <!-- Video Container -->
                        <div class="relative w-full h-full">
                            <video id="demo-video" class="w-full h-full object-contain" controls preload="metadata" controlsList="nodownload">
                                <source src="../videos/Stairway-To-Heaven-Video.mp4" type="video/mp4">
                                <source src="../videos/Stairway-To-Heaven-Video.webm" type="video/webm">
                                Your browser does not support the video tag.
                            </video>
                            
                            <!-- Video Title Overlay -->
                            <div class="absolute bottom-0 left-0 right-0 p-4" style="background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                                <h3 class="text-white text-lg font-semibold">Stairway to Heaven - LyricArt Demo</h3>
                                <p class="text-gray-300 text-sm">See how we transform classic lyrics into stunning visual art</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Add click outside to close functionality
            const modal = document.getElementById('video-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeVideoModal();
                }
            });
            
            // Add escape key to close functionality
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeVideoModal();
                }
            });
            
            // Auto-play video when modal opens
            const video = document.getElementById('demo-video');
            if (video) {
                // Ensure video is not muted and volume is set
                video.muted = false;
                video.volume = 1.0;
                
                video.play().catch(function(error) {
                    console.log('Video autoplay was prevented:', error);
                });
            }
        }

        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            if (modal) {
                // Stop video before removing modal
                const video = document.getElementById('demo-video');
                if (video) {
                    video.pause();
                    video.currentTime = 0;
                }
                
                modal.remove();
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }

        // Custom Design Request Modal Functions
        function openCommissionModal() {
            const modalHTML = `
                <div id="commission-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 10px;">
                    <div style="background: #1a1a1a; border-radius: 8px; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; position: relative;">
                        <button onclick="closeCommissionModal()" style="position: absolute; top: 10px; right: 10px; background: #333; border: none; color: white; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">×</button>
                        
                        <div style="padding: 25px;">
                            <h2 style="text-align: center; margin: 0 0 10px 0; color: white; font-size: 18px;">CUSTOM DESIGN REQUEST</h2>
                            <p style="text-align: center; margin: 0 0 20px 0; color: #999; font-size: 13px;">Custom lyric art</p>
                            
                            <form id="commission-form" style="display: flex; flex-direction: column; gap: 18px;">
                                <div>
                                    <label style="display: block; margin-bottom: 10px; color: white; font-size: 13px; font-weight: bold;">Choose Your Design Style</label>
                                    <p style="color: #999; font-size: 11px; margin-bottom: 10px;">Select the design style you prefer for your custom lyrics word art:</p>
                                    
                                    <div style="background: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                        <button type="button" onclick="openDesignExamples()" style="width: 100%; background: #00d4ff; color: black; border: none; border-radius: 6px; padding: 12px; font-size: 13px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                                            📋 View Design Examples
                                        </button>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-1" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #1</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-2" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #2</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-3" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #3</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-4" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #4</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-5" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #5</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-6" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #6</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-7" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #7</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-8" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #8</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-9" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #9</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-10" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #10</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-11" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #11</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-12" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #12</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-13" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #13</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-14" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #14</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-15" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #15</div>
                                            </label>
                                            <label style="cursor: pointer;">
                                                <input type="radio" name="design-style" value="design-16" style="display: none;" required>
                                                <div class="design-option" style="background: #444; border: 2px solid #555; border-radius: 6px; padding: 6px; text-align: center; color: white; font-size: 11px; font-weight: bold; transition: all 0.2s;">Design #16</div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: white; font-size: 13px;">Artist *</label>
                                        <input type="text" name="artist-name" required style="width: 100%; background: #333; border: 1px solid #555; border-radius: 4px; padding: 10px; color: white; font-size: 13px; box-sizing: border-box;" placeholder="e.g., Led Zeppelin">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: white; font-size: 13px;">Song *</label>
                                        <input type="text" name="song-title" required style="width: 100%; background: #333; border: 1px solid #555; border-radius: 4px; padding: 10px; color: white; font-size: 13px; box-sizing: border-box;" placeholder="e.g., Stairway to Heaven">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: white; font-size: 12px;">Lyrics *</label>
                                    <textarea name="lyrics" required rows="2" style="width: 100%; background: #333; border: 1px solid #555; border-radius: 4px; padding: 8px; color: white; font-size: 12px; box-sizing: border-box; resize: none;" placeholder="Paste lyrics here..."></textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: white; font-size: 12px;">Notes</label>
                                    <textarea name="additional-notes" rows="1" style="width: 100%; background: #333; border: 1px solid #555; border-radius: 4px; padding: 8px; color: white; font-size: 12px; box-sizing: border-box; resize: none;" placeholder="Special requests..."></textarea>
                                </div>
                                
                                <div style="background: #333; border-radius: 4px; padding: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <h3 style="margin: 0; color: white; font-size: 12px;">Price</h3>
                                        <span style="color: #00d4ff; font-size: 14px; font-weight: bold;">$10.00</span>
                                    </div>
                                    <ul style="margin: 0; padding-left: 15px; color: #999; font-size: 10px;">
                                        <li>High-res digital file</li>
                                        <li>2 revisions included</li>
                                        <li>3-5 day delivery</li>
                                    </ul>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" style="flex: 1; background: #00d4ff; color: black; border: none; border-radius: 4px; padding: 10px; font-size: 12px; font-weight: bold; cursor: pointer;">PURCHASE</button>
                                    <button type="button" onclick="closeCommissionModal()" style="flex: 1; background: transparent; color: #00d4ff; border: 1px solid #00d4ff; border-radius: 4px; padding: 10px; font-size: 12px; cursor: pointer;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Add form submission handler
            document.getElementById('commission-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitCommission();
            });

            // Add event listeners for design option selection
            document.querySelectorAll('.design-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    document.querySelectorAll('.design-option').forEach(opt => {
                        opt.style.border = '2px solid #555';
                        opt.style.background = '#444';
                    });
                    // Add active class to selected option
                    this.style.border = '2px solid #00d4ff';
                    this.style.background = '#00d4ff20';
                });
            });

            // Add click outside to close functionality
            const modal = document.getElementById('commission-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCommissionModal();
                }
            });

            // Add escape key to close functionality
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeCommissionModal();
                }
            });
        }

        function closeCommissionModal() {
            const modal = document.getElementById('commission-modal');
            if (modal) {
                modal.remove();
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }

        function submitCommission() {
            // Get form data
            const formData = new FormData(document.getElementById('commission-form'));
            const commissionData = {
                designStyle: formData.get('design-style'),
                artistName: formData.get('artist-name'),
                songTitle: formData.get('song-title'),
                lyrics: formData.get('lyrics'),
                additionalNotes: formData.get('additional-notes'),
                price: 10.00
            };

            // Add to shopping cart using server-side cart
            addCustomDesignToCartServer(commissionData);

            // Show success message
            const successHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.8);">
                    <div class="bg-background rounded-lg p-8 max-w-md w-full text-center">
                        <div class="w-12 h-12 mx-auto mb-4 bg-accent/20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-montserrat font-bold mb-2">Custom Design Added to Cart!</h3>
                        <p class="text-text-secondary mb-4">Your custom design has been added to your shopping cart.</p>
                        <p class="text-text-secondary mb-6">You can add more designs or proceed to checkout when ready.</p>
                        <div class="flex gap-3">
                            <button onclick="closeSuccessModal()" class="flex-1 bg-surface border border-border-subtle text-text-primary py-2 px-4 rounded-lg hover:bg-surface/80 transition-smooth">
                                Add Another Design
                            </button>
                            <button onclick="window.location.href='/pages/checkout.html'" class="flex-1 btn-primary">
                                View Cart
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', successHTML);
            closeCommissionModal();
        }

        async function addCustomDesignToCartServer(commissionData) {
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        itemId: `custom-${Date.now()}`,
                        qty: 1,
                        price: commissionData.price,
                        format: 'Custom Design',
                        commissionData: commissionData
                    })
                });
                
                if (response.ok) {
                    await updateCartBadge();
                    showNotification('Custom design added to cart!', 'success');
                } else {
                    throw new Error('Failed to add to cart');
                }
            } catch (error) {
                console.error('Error adding custom design to cart:', error);
                showNotification('Failed to add custom design to cart', 'error');
            }
        }

        function addCustomDesignToCart(commissionData) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Create unique title for cart
            const cartTitle = `Custom Design: ${commissionData.artistName} - ${commissionData.songTitle}`;
            
            // Add to cart with all commission details
            cart.push({
                title: cartTitle,
                price: commissionData.price,
                id: Date.now(),
                type: 'custom-design',
                commissionData: commissionData
            });
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();
            showNotification('Custom design added to cart!', 'success');
        }

        function closeSuccessModalAndOpenCart() {
            closeSuccessModal();
            openCartModal();
        }

        function closeSuccessModal() {
            const modal = document.querySelector('.fixed.inset-0.z-50');
            if (modal) {
                modal.remove();
            }
        }

        function openDesignExamples() {
            const modalHTML = `
                <div id="design-examples-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: #1a1a1a; border-radius: 12px; width: 100%; max-width: 1200px; max-height: 95vh; overflow-y: auto; position: relative;">
                        <button onclick="closeDesignExamples()" style="position: absolute; top: 15px; right: 15px; background: #333; border: none; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px; z-index: 10;">×</button>
                        
                        <div style="padding: 30px;">
                            <h2 style="text-align: center; margin: 0 0 20px 0; color: white; font-size: 28px; font-weight: bold;">Design Style Examples</h2>
                            <p style="text-align: center; margin: 0 0 25px 0; color: #999; font-size: 16px;">Zoom in to see details clearly, then choose your preferred design style</p>
                            
                            <div style="margin-bottom: 30px;">
                                <div id="design-examples-viewer" style="width: 100%; height: 500px; border-radius: 8px; border: 2px solid #333; background: #000;"></div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px;">
                                <button type="button" onclick="selectDesign(1)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #1</button>
                                <button type="button" onclick="selectDesign(2)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #2</button>
                                <button type="button" onclick="selectDesign(3)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #3</button>
                                <button type="button" onclick="selectDesign(4)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #4</button>
                                <button type="button" onclick="selectDesign(5)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #5</button>
                                <button type="button" onclick="selectDesign(6)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #6</button>
                                <button type="button" onclick="selectDesign(7)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #7</button>
                                <button type="button" onclick="selectDesign(8)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #8</button>
                                <button type="button" onclick="selectDesign(9)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #9</button>
                                <button type="button" onclick="selectDesign(10)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #10</button>
                                <button type="button" onclick="selectDesign(11)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #11</button>
                                <button type="button" onclick="selectDesign(12)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #12</button>
                                <button type="button" onclick="selectDesign(13)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #13</button>
                                <button type="button" onclick="selectDesign(14)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #14</button>
                                <button type="button" onclick="selectDesign(15)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #15</button>
                                <button type="button" onclick="selectDesign(16)" class="design-select-btn" style="background: #444; border: 2px solid #555; border-radius: 8px; padding: 12px; text-align: center; color: white; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Design #16</button>
                            </div>
                            
                            <div style="text-align: center;">
                                <button onclick="closeDesignExamples()" style="background: #00d4ff; color: black; border: none; border-radius: 6px; padding: 12px 24px; font-size: 14px; font-weight: bold; cursor: pointer;">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Add click outside to close functionality
            const modal = document.getElementById('design-examples-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDesignExamples();
                }
            });

            // Add escape key to close functionality
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDesignExamples();
                }
            });

            // Display the image with proper zoom and pan functionality
            const viewerDiv = document.getElementById('design-examples-viewer');
            viewerDiv.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%; overflow: hidden; border-radius: 8px; background: #000;">
                    <div id="image-container" style="position: relative; width: 100%; height: 100%; overflow: hidden;">
                        <img src="../images/guitar_examples.jpg" 
                             alt="Guitar Design Examples" 
                             style="width: 100%; height: 100%; object-fit: contain; cursor: grab; user-select: none;"
                             id="design-examples-image"
                             draggable="false">
                    </div>
                    <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 10;">
                        <div>🖱️ Drag to pan • 🔍 Scroll to zoom • 🎯 Click to reset</div>
                    </div>
                    <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 10;">
                        <button onclick="resetZoom()" style="background: #00d4ff; color: black; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 8px;">Reset View</button>
                        <span id="zoom-level">100%</span>
                    </div>
                </div>
            `;
            
            // Zoom and pan functionality
            let currentScale = 1;
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;
            const image = document.getElementById('design-examples-image');
            const container = document.getElementById('image-container');
            const zoomLevel = document.getElementById('zoom-level');
            
            // Reset zoom function
            window.resetZoom = function() {
                currentScale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            };
            
            // Update transform
            function updateTransform() {
                image.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
                zoomLevel.textContent = Math.round(currentScale * 100) + '%';
                
                if (currentScale > 1) {
                    image.style.cursor = 'grab';
                    container.style.cursor = 'grab';
                } else {
                    image.style.cursor = 'grab';
                    container.style.cursor = 'grab';
                }
            }
            
            // Mouse down - start dragging
            let initialMouseX, initialMouseY;
            container.addEventListener('mousedown', function(e) {
                if (currentScale > 1) {
                    isDragging = true;
                    initialMouseX = e.clientX;
                    initialMouseY = e.clientY;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    image.style.cursor = 'grabbing';
                    container.style.cursor = 'grabbing';
                }
            });
            
            // Mouse move - dragging
            document.addEventListener('mousemove', function(e) {
                if (isDragging && currentScale > 1) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    updateTransform();
                }
            });
            
            // Mouse up - stop dragging
            document.addEventListener('mouseup', function(e) {
                if (isDragging) {
                    // Check if we actually moved (drag vs click)
                    const moveDistance = Math.sqrt(
                        Math.pow(e.clientX - initialMouseX, 2) + 
                        Math.pow(e.clientY - initialMouseY, 2)
                    );
                    
                    if (moveDistance < 3) {
                        // It was a click, not a drag - reset zoom
                        setTimeout(() => {
                            if (!isDragging && currentScale > 1) {
                                resetZoom();
                            }
                        }, 50);
                    }
                    
                    isDragging = false;
                    image.style.cursor = 'grab';
                    container.style.cursor = 'grab';
                }
            });
            
            // Scroll to zoom
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                const rect = container.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const oldScale = currentScale;
                if (e.deltaY < 0) {
                    currentScale = Math.min(currentScale * 1.1, 5);
                } else {
                    currentScale = Math.max(currentScale * 0.9, 0.5);
                }
                
                // Adjust translation to zoom towards mouse position
                const scaleChange = currentScale / oldScale;
                translateX = mouseX - (mouseX - translateX) * scaleChange;
                translateY = mouseY - (mouseY - translateY) * scaleChange;
                
                updateTransform();
            });
        }

        function closeDesignExamples() {
            const modal = document.getElementById('design-examples-modal');
            if (modal) {
                modal.remove();
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }

        function selectDesign(designNumber) {
            // Select the corresponding radio button in the main form
            const radioButton = document.querySelector(`input[name="design-style"][value="design-${designNumber}"]`);
            if (radioButton) {
                radioButton.checked = true;
                
                // Update the visual styling of the design options
                document.querySelectorAll('.design-option').forEach(opt => {
                    opt.style.border = '2px solid #555';
                    opt.style.background = '#444';
                });
                
                const selectedOption = document.querySelector(`input[name="design-style"][value="design-${designNumber}"]`).parentElement.querySelector('.design-option');
                if (selectedOption) {
                    selectedOption.style.border = '2px solid #00d4ff';
                    selectedOption.style.background = '#00d4ff20';
                }
            }
            
            // Close the examples modal
            closeDesignExamples();
        }

        // Function to open design viewer with OpenSeadragon
        function openProtectedDesignViewer(imagePath, songTitle, artistName) {
            console.log('Opening OpenSeadragon design viewer:', imagePath);
            
            // Create modal HTML
            const modalHTML = `
                <div id="protected-viewer-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 8px;">
                    <div style="position: relative; width: 100%; height: 100%; max-width: 1200px; max-height: 95vh; background-color: white; border-radius: 8px; overflow: hidden;">
                        <!-- Header -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to right, #2563EB, #1D4ED8); color: white; padding: 12px; z-index: 10;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1; min-width: 0;">
                                    <h2 style="font-size: 18px; font-weight: bold; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${songTitle}</h2>
                                    <p style="font-size: 12px; opacity: 0.9; margin: 4px 0 0 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${artistName}</p>
                                </div>
                                <button onclick="closeProtectedViewerModal()" style="color: white; background: none; border: none; font-size: 24px; font-weight: bold; cursor: pointer; margin-left: 8px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                    ×
                                </button>
                            </div>
                        </div>
                        
                        <!-- OpenSeadragon Container -->
                        <div id="protected-viewer-container" style="width: 100%; height: 100%; margin-top: 60px; background-color: white;">
                            <div id="openseadragon-viewer" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <!-- Instructions -->
                        <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background-color: rgba(0, 0, 0, 0.75); color: white; padding: 8px; border-radius: 8px; font-size: 12px; text-align: center;">
                            <p style="margin: 0;">🔍 Scroll to zoom • 🖱️ Drag to pan • 📱 Pinch to zoom on mobile</p>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialize OpenSeadragon viewer
            try {
                if (typeof OpenSeadragon === 'undefined') {
                    console.error('❌ OpenSeadragon not loaded, falling back to simple viewer');
                    // Fallback to simple image
                    const container = document.getElementById('protected-viewer-container');
                    container.innerHTML = `<img src="${imagePath}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px;" alt="${songTitle}">`;
                    return;
                }
                
                // Create OpenSeadragon viewer
                const viewer = OpenSeadragon({
                    id: 'openseadragon-viewer',
                    prefixUrl: 'https://openseadragon.github.io/openseadragon/images/',
                    tileSources: {
                        type: 'image',
                        url: imagePath,
                        buildPyramid: false
                    },
                    minZoomLevel: 0.5,
                    maxZoomLevel: 8,
                    zoomPerScroll: 1.1,
                    zoomPerClick: 1.5,
                    animationTime: 0.8,
                    blendTime: 0.1,
                    alwaysBlend: false,
                    immediateRender: false,
                    wrapHorizontal: false,
                    wrapVertical: false,
                    wrapOverlays: false,
                    panHorizontal: true,
                    panVertical: true,
                    showNavigator: false,
                    showRotationControl: false,
                    showZoomControl: false,
                    showHomeControl: false,
                    showFullPageControl: false
                });
                
                console.log('✅ OpenSeadragon viewer created successfully');
                
            } catch (error) {
                console.error('❌ Error creating OpenSeadragon viewer:', error);
                // Fallback to simple image
                const container = document.getElementById('protected-viewer-container');
                container.innerHTML = `<img src="${imagePath}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px;" alt="${songTitle}">`;
            }
        }

        // Close protected viewer modal
        function closeProtectedViewerModal() {
            const modal = document.getElementById('protected-viewer-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProtectedViewerModal();
            }
        });

        // Shopping Cart Functions
        async function updateCartBadge() {
            try {
                console.log('🛒 Updating cart badge...');
                const response = await fetch('/api/cart/count', { credentials: 'include' });
                const data = await response.json();
                console.log('🛒 Cart count data:', data);
                
                const cartCount = document.getElementById('cart-count');
                if (!cartCount) {
                    console.error('❌ Cart count element not found!');
                    return;
                }
                
                const count = data.count || 0;
                console.log('🛒 Cart count:', count);
                
                cartCount.textContent = count;
                // Always show the cart count, even when 0
                cartCount.classList.remove('hidden');
                console.log('✅ Cart count updated to:', count);
            } catch (error) {
                console.error('❌ Error updating cart badge:', error);
                const cartCount = document.getElementById('cart-count');
                if (cartCount) {
                    cartCount.classList.add('hidden');
                }
            }
        }

        async function addToCart(songTitle, price) {
            try {
                console.log('🛒 Add to Cart clicked for:', songTitle, 'at price:', price);
                const itemId = songTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                console.log('🛒 Item ID:', itemId);
                
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ itemId: itemId, qty: 1 })
                });
                
                console.log('🛒 Add to cart response status:', response.status);
                const data = await response.json();
                console.log('🛒 Add to cart response data:', data);
                
                if (response.ok && data.ok) {
                    console.log('✅ Successfully added to cart!');
                    showNotification(`"${songTitle}" successfully added to cart!`, 'success');
                    updateCartBadge();
                } else {
                    console.error('❌ Failed to add to cart:', data.error || 'Unknown error');
                    showNotification('Failed to add to cart', 'error');
                }
            } catch (error) {
                console.error('❌ Error in addToCart:', error);
                showNotification('Error adding to cart', 'error');
            }
        }



        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            
            // Create a more prominent notification with icon
            let icon = '';
            let bgColor = '';
            
            if (type === 'success') {
                icon = '✅';
                bgColor = 'bg-green-500';
            } else if (type === 'error') {
                icon = '❌';
                bgColor = 'bg-red-500';
            } else {
                icon = 'ℹ️';
                bgColor = 'bg-blue-500';
            }
            
            notification.innerHTML = `${icon} ${message}`;
            notification.className = `fixed top-6 right-6 px-6 py-4 rounded-lg shadow-xl transform translate-x-full transition-all duration-500 z-50 ${bgColor} text-white font-semibold text-lg border-2 border-white`;
            notification.classList.remove('translate-x-full');
            
            // Add a subtle bounce effect
            setTimeout(() => {
                notification.style.transform = 'translateX(0) scale(1.05)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0) scale(1)';
            }, 200);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
            }, 4000);
        }

        // Secure User Authentication Functions
        let authCheckInProgress = false;
        let lastAuthStatus = null;
        
        function checkAuthStatus() {
            if (authCheckInProgress) {
                console.log('⏳ Auth check already in progress, skipping...');
                return;
            }
            
            authCheckInProgress = true;
            console.log('🔍 Checking authentication status...');
            
            fetch('/api/auth/status', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                console.log('📡 Auth status response:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 Auth status data:', data);
                
                // Check if status actually changed
                const currentStatus = data.loggedIn ? 'logged-in' : 'logged-out';
                if (lastAuthStatus === currentStatus) {
                    console.log('🔄 Auth status unchanged, skipping UI update');
                    authCheckInProgress = false;
                    return;
                }
                
                lastAuthStatus = currentStatus;
                
                if (data.loggedIn) {
                    console.log('✅ User is logged in:', data.user.email);
                    updateUIForLoggedInUser(data.user);
                } else {
                    console.log('❌ User is not logged in');
                    updateUIForLoggedOutUser();
                }
                
                authCheckInProgress = false;
            })
            .catch(error => {
                console.error('💥 Auth check error:', error);
                console.log('❌ Assuming not logged in due to error');
                updateUIForLoggedOutUser();
                authCheckInProgress = false;
            });
        }
        
        function updateUIForLoggedInUser(user) {
            console.log('🔧 Updating UI for logged-in user:', user.email);
            
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            const userEmail = document.getElementById('user-email');
            
            // Force immediate UI update with multiple approaches
            if (authButtons) {
                authButtons.classList.add('hidden');
                authButtons.style.display = 'none';
                authButtons.style.visibility = 'hidden';
                console.log('✅ Auth buttons hidden');
            }
            
            if (userMenu) {
                userMenu.classList.remove('hidden');
                userMenu.style.display = 'flex';
                userMenu.style.visibility = 'visible';
                console.log('✅ User menu shown');
            }
            
            if (userEmail) {
                userEmail.textContent = user.email;
                console.log('✅ User email set to:', user.email);
            }
            
            // Force browser reflow
            document.body.offsetHeight;
            
            console.log('✅ UI updated for logged-in user');
        }
        
        function updateUIForLoggedOutUser() {
            console.log('🔧 Updating UI for logged-out user');
            
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            
            // Force immediate UI update with multiple approaches
            if (authButtons) {
                authButtons.classList.remove('hidden');
                authButtons.style.display = 'flex';
                authButtons.style.visibility = 'visible';
                console.log('✅ Auth buttons shown');
            }
            
            if (userMenu) {
                userMenu.classList.add('hidden');
                userMenu.style.display = 'none';
                userMenu.style.visibility = 'hidden';
                console.log('✅ User menu hidden');
            }
            
            // Force browser reflow
            document.body.offsetHeight;
            
            console.log('✅ UI updated for logged-out user');
        }

        // Force auth check function (for debugging)
        function forceAuthCheck() {
            console.log('🔄 Manual force auth check triggered');
            checkAuthStatus();
        }

        async function logout() {
            try {
                console.log('🚪 Logging out...');
                
                const response = await fetch('/api/auth/logout', { 
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('🚪 Logout response:', data);
                
                if (data.success) {
                    console.log('✅ Logout successful, updating UI...');
                    
                    // Clear any client-side data
                    localStorage.removeItem('cart');
                    
                    // Update UI immediately
                    const authButtons = document.getElementById('auth-buttons');
                    const userMenu = document.getElementById('user-menu');
                    
                    if (authButtons) authButtons.classList.remove('hidden');
                    if (userMenu) userMenu.classList.add('hidden');
                    
                    // Update cart count
                    updateCartBadge();
                    
                    console.log('✅ UI updated, user logged out');
                    showNotification('Logged out successfully', 'success');
                } else {
                    console.error('❌ Logout failed:', data.error);
                    showNotification('Logout failed', 'error');
                }
            } catch (error) {
                console.error('💥 Logout error:', error);
                showNotification('Logout failed', 'error');
            }
        }

        // Subscription Function
        function subscribe() {
            const email = document.getElementById('subscription-email').value;
            if (!email) {
                showNotification('Please enter your email', 'error');
                return;
            }

            fetch('/api/subscription/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Subscribed successfully!', 'success');
                    document.getElementById('subscription-email').value = '';
                } else {
                    showNotification(data.error || 'Subscription failed', 'error');
                }
            })
            .catch(error => {
                showNotification('Subscription failed', 'error');
            });
        }

        // Secure initialization system
        let authInitialized = false;
        let authCheckAttempts = 0;
        const MAX_AUTH_ATTEMPTS = 5;
        
        function initializeAuth() {
            if (authInitialized) {
                console.log('✅ Auth already initialized');
                return;
            }
            
            console.log('🚀 Initializing secure authentication...');
            checkAuthStatus();
            
            // Intelligent retry system
            const authRetryInterval = setInterval(() => {
                authCheckAttempts++;
                console.log(`🔄 Auth check attempt ${authCheckAttempts}/${MAX_AUTH_ATTEMPTS}`);
                
                if (authCheckAttempts >= MAX_AUTH_ATTEMPTS) {
                    clearInterval(authRetryInterval);
                    authInitialized = true;
                    console.log('✅ Auth initialization complete');
                    return;
                }
                
                // Only retry if we haven't confirmed login status
                if (lastAuthStatus === null) {
                    checkAuthStatus();
                } else {
                    clearInterval(authRetryInterval);
                    authInitialized = true;
                    console.log('✅ Auth status confirmed, initialization complete');
                }
            }, 1000);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Homepage loaded, initializing...');
            updateCartBadge();
            initializeAuth();
        });

        // Also initialize immediately when script loads
        console.log('🔍 Immediate auth initialization...');
        initializeAuth();

        // Initialize page functionality
        document.addEventListener('DOMContentLoaded', function() {
            updateCartBadge();
            checkAuthStatus();
            setInterval(checkAuthStatus, 30000);
        });

        // Buy now functionality - add to cart and immediately checkout
        async function buyNow(songTitle, price) {
            try {
                console.log('🛒 Buy Now clicked for:', songTitle, 'at price:', price);
                const itemId = songTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                console.log('🛒 Item ID:', itemId);
                
                const addResponse = await fetch('/api/cart/add', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        itemId: itemId,
                        qty: 1,
                        price: price,
                        format: 'SVG'
                    })
                });
                
                console.log('🛒 Add to cart response status:', addResponse.status);
                const addData = await addResponse.json();
                console.log('🛒 Add to cart response data:', addData);
                
                if (addResponse.ok && addData.ok) {
                    console.log('✅ Successfully added to cart!');
                    showNotification('Added to cart! Redirecting to checkout...', 'success');
                    
                    // Update cart count before redirecting
                    updateCartBadge();
                    
                    // Immediately redirect to checkout page
                    setTimeout(() => {
                        console.log('🔄 Redirecting to checkout...');
                        window.location.href = '/checkout';
                    }, 1000);
                } else {
                    console.error('❌ Failed to add to cart:', addData.error || 'Unknown error');
                    showNotification('Failed to add to cart', 'error');
                }
            } catch (error) {
                console.error('❌ Error in buyNow:', error);
                showNotification('Error processing purchase', 'error');
            }
        }
    </script>
    
    <!-- Song Catalog -->
    <script src="../public/song-catalog.js"></script>
    
    <!-- Enhanced Protected Image Viewer -->
    <!-- OpenSeadragon viewer script removed to fix cart functionality -->
</body>
</html>